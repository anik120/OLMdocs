---
title: "Shipping an operator that includes Webhook"
linkTitle: "Admission and Conversion Webhooks"
weight: 3
---

## Defining your Webhook in the ClusterServiceVersion

OLM is capable of managing the lifecycle of [validating](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook) and [mutating](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#mutatingadmissionwebhook) admission webhooks that are shipped alongside your operator.  To this end, the [ClusterServiceVersion resource](/docs/Concepts/crds/clusterserviceversion) includes a [WebhookDefinition object](https://github.com/operator-framework/api/blob/7856a40f92893fe94d19d223f5277d1d116ffc67/pkg/operators/v1alpha1/clusterserviceversion_types.go#L164-L180) which can be used to define validating and mutating admission webhooks that will be shipped with the operator. For your convenience, an example of a Validating WebhookDefinition can be seen below:

```yaml
apiVersion: operators.coreos.com/v1alpha1
kind: ClusterServiceVersion
metadata:
  annotations:
    description: |-
      An example CSV that contains a webhook
  name: example-webhook.v1.0.0
  namespace: placeholder
spec:
  webhookdefinitions:
  - generateName: example.webhook.com
    type: ValidatingAdmissionWebhook
    deploymentName: "example-webhook-deployment"
    containerPort: 443
    sideEffects: "None"
    failurePolicy: "Ignore"
    admissionReviewVersions:
    - "v1"
    - "v1beta1"
    rules:
    - operations:
      - "CREATE"
      apiGroups:
      - ""
      apiVersions:
      - "v1"
      resources:
      - "configmaps"
    objectSelector:
      foo: bar
    webhookPath: "/validate"
...
...
...
```

The `WebhookDescription` object contains a union of the fields defined in the AdmissionWebhook and ValidatingWebhook Kubernetes objects with the exception of the NamespaceSelector, which is generated by OLM to match namespaces scoped by the [OperatorGroup](./operator-scoping.md) that the operator is deployed in.

OLM requires that you define the following:

- The `Type` field must be set to `ValidatingAdmissionWebhook` or `MutatingAdmissionWebhook` or the CSV will be placed in the failed phase.
- The CSV must contain a Deployment whose name is equivalent to the value supplied in the `DeploymentName` field of the `WebhookDescription`.

### Creating an Admission Webhook

When developing an [admission webhook](/docs/reference/admission-webhooks) that will be managed by OLM you should consider the following constraints.

#### Certificate Authority Constraints

OLM is configured to provide each deployment with a single Certificate Authority (CA). The logic that generates and mounts the CA into the deployment was originally used by the [API Service](https://kubernetes.io/docs/tasks/access-kubernetes-api/setup-extension-api-server/) lifecycle logic. As a result:

- The tls Cert file will be mounted to the deployment at `/apiserver.local.config/certificates/apiserver.crt`
- The tls Key file will be mounted to the deployment at `/apiserver.local.config/certificates/apiserver.key`

#### Admission Webhook Rules Constraints

Additionally, in an attempt to prevent operator from configuring the cluster into an unrecoverable state, OLM will place the CSV in the failed phase if the Rules defined in an admission webhook:

- Intercept requests that target all groups
- Intercept requests that target the `operators.coreos.com` group
- Intercept requests that target the `ValidatingWebhookConfigurations` or `MutatingWebhookConfigurations` resources

### Conversion Webhook support

OLM allows Operators to ship with [CRD Conversion](https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/#webhook-conversion) Webhooks when they only support the `AllNamespaces` installMode.
Operator Authors may specify which of their owned CRDs rely on the Conversion Webhook by listing each of the CRD names in the `WebhookDefinitions.conversionCRDs` array within the operators `ClusterServiceVersion`.

Please refer to the implementation of the [custom resource conversion webhook server](https://book.kubebuilder.io/multiversion-tutorial/conversion.html) as an example on how to write a conversion webhook server. 

#### Example:

```yaml
...
...
...
spec:
  webhookdefinitions:
  - generateName: example.webhook.com
    type: ValidatingAdmissionWebhook
    deploymentName: "example-webhook-deployment"
    containerPort: 443
    sideEffects: "None"
    failurePolicy: "Ignore"
    admissionReviewVersions:
    - "v1"
    - "v1beta1"
    rules:
    - operations:
      - "CREATE"
      apiGroups:
      - ""
      apiVersions:
      - "v1"
      resources:
      - "configmaps"
    objectSelector:
      foo: bar
    webhookPath: "/validate"
    conversionCRDs: 
    - "crontabs.stable.example.com"
  customresourcedefinitions:
    owned:
    - description: Crontab is a sample Schema
      kind: Crontab
      name: crontabs.stable.example.com
      version: v1   
  description: |
    A simple Webhook.
  displayName: Simple Webhook
  install:
    spec:
      deployments:
      - name: example-webhook-deployment
        spec:
          replicas: 1
          selector:
            matchLabels:
                name: example-webhook-deployment
          template:
            metadata:
              labels:
                name: example-webhook-deployment
            spec:
              containers:
                - name: example-webhook-deployment
                  image: quay.io/username/example-webhook-deployment
                  args:
                  - -tls-cert-file=/apiserver.local.config/certificates/apiserver.crt
                  - -tls-private-key-file=/apiserver.local.config/certificates/apiserver.key
    strategy: deployment
  installModes:
  - supported: false
    type: OwnNamespace
  - supported: false
    type: SingleNamespace
  - supported: false
    type: MultiNamespace
  - supported: true
    type: AllNamespaces
...
...
...
```

The CRDs will need to specify the `spec.conversion.strategy` as `Webhook` and also provide the `spec.conversion.webhook.clientconfig.service.path` where the server would be serving the traffic for conversion webhook requests. The service `name` and `namespace` can be set to be any sample strings as OLM will replace these fields to match that of the service it creates. 

For more information about defining Conversion Webhook CRDs, please refer to [Configure CustomResourceDefinition to use conversion webhooks](https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/#configure-customresourcedefinition-to-use-conversion-webhooks)

#### Example: 
```
...
...
...
  conversion:
    strategy: Webhook
    webhookClientConfig:
      service:
        namespace: default
        name: example-webhook-name
        path: /crdconvert 
...
...
...
```

OLM requires that you:
- define these CRDs under spec.customresourcedefinitions.owned in `ClusterServiceVersion`.  
- provide these CRDs in the Operator Bundle.
- try to leverage this feature only for AllNamespace Operators or else the CSV installation will fail.
